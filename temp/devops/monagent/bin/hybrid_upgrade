#!/bin/sh
PRODUCT_NAME='Site24x7'
PRODUCT_NAME_UPPERCASE='SITE24X7'
PRODUCT_NAME_LOWERCASE='site24x7'
MON_AGENT_NAME='monagent'
MON_AGENT_GROUP=$PRODUCT_NAME_LOWERCASE'-group'
MON_AGENT_USER=$PRODUCT_NAME_LOWERCASE'-agent'
MON_AGENT_BIN_DIR=$MON_AGENT_HOME/bin
MON_AGENT_VENV_DIR=$MON_AGENT_HOME/../venv
MON_AGENT_VENV_DIR_PYTHON=$MON_AGENT_VENV_DIR/bin/python
MON_AGENT_LOG_DIR=$MON_AGENT_HOME/logs
MON_AGENT_TEMP_DIR=$MON_AGENT_HOME/temp
MON_AGENT_TEMP_LOCKFILE=$MON_AGENT_TEMP_DIR/lockfile.txt
MON_AGENT_UPGRADE_SCRIPT_LOG_FILE_NAME='upgrade_script.txt'
MON_AGENT_UPGRADE_DIR=$MON_AGENT_HOME/upgrade
MON_AGENT_UPGRADE_HOME_DIR=$MON_AGENT_UPGRADE_DIR/monagent
MON_AGENT_BIN_PROFILE_FILE_NAME='profile.sh'
MON_AGENT_BIN_PROFILE_ENV_FILE_NAME='profile.env.sh'
MON_AGENT_PROFILE_FILE_NAME='.profile'
MON_AGENT_PROFILE_ENV_FILE_NAME='.profile.env'
MON_AGENT_BOOT_SERVICE_FILE_NAME='monagentservice'
MON_AGENT_BOOT_FILE_NAME=$PRODUCT_NAME_LOWERCASE'monagent'
MON_AGENT_UPGRADE_SCRIPT_LOG_FILE=$MON_AGENT_LOG_DIR/$MON_AGENT_UPGRADE_SCRIPT_LOG_FILE_NAME
MON_AGENT_BIN_PROFILE=$MON_AGENT_BIN_DIR/$MON_AGENT_BIN_PROFILE_FILE_NAME
MON_AGENT_BIN_PROFILE_ENV=$MON_AGENT_BIN_DIR/$MON_AGENT_BIN_PROFILE_ENV_FILE_NAME
NEW_MON_AGENT_BIN_BOOT_FILE=$MON_AGENT_BIN_DIR/new_monagent
NEW_MON_AGENT_WATCHDOG_BIN_BOOT_FILE=$MON_AGENT_BIN_DIR/new_monagentwatchdog
NEW_MON_AGENT_PROFILE=$MON_AGENT_HOME/.new_profile
MON_AGENT_PROFILE=$MON_AGENT_HOME/$MON_AGENT_PROFILE_FILE_NAME
MON_AGENT_PROFILE_ENV=$MON_AGENT_HOME/$MON_AGENT_PROFILE_ENV_FILE_NAME
MON_AGENT_BIN_BOOT_FILE=$MON_AGENT_BIN_DIR/monagent
MON_AGENT_WATCHDOG_BIN_BOOT_FILE=$MON_AGENT_BIN_DIR/monagentwatchdog

createNecessaryDirs() {
	if [ ! -d $MON_AGENT_LOG_DIR ]; then
        mkdir -p $MON_AGENT_LOG_DIR
        chown -vR $MON_AGENT_USER:$MON_AGENT_GROUP $MON_AGENT_LOG_DIR 2>> $MON_AGENT_UPGRADE_SCRIPT_LOG_FILE
		chmod -vR 755 $MON_AGENT_LOG_DIR 2>> $MON_AGENT_UPGRADE_SCRIPT_LOG_FILE
    fi
}

setPermissions() {
	chown -R $MON_AGENT_USER:$MON_AGENT_GROUP $MON_AGENT_HOME 2>> $MON_AGENT_UPGRADE_SCRIPT_LOG_FILE
	chmod -R 755 $MON_AGENT_HOME 2>> $MON_AGENT_UPGRADE_SCRIPT_LOG_FILE
}

change_switch_value(){
	sed "s/MON_AGENT_WATCHDOG_SWITCH=.*/MON_AGENT_WATCHDOG_SWITCH=$1/" $MON_AGENT_WATCHDOG_BIN_BOOT_FILE > $NEW_MON_AGENT_WATCHDOG_BIN_BOOT_FILE
	sed "s/MON_AGENT_SWITCH=.*/MON_AGENT_SWITCH=$1/" $MON_AGENT_BIN_BOOT_FILE > $NEW_MON_AGENT_BIN_BOOT_FILE
	mv $NEW_MON_AGENT_WATCHDOG_BIN_BOOT_FILE $MON_AGENT_WATCHDOG_BIN_BOOT_FILE 2>> $MON_AGENT_UPGRADE_SCRIPT_LOG_FILE
	mv $NEW_MON_AGENT_BIN_BOOT_FILE $MON_AGENT_BIN_BOOT_FILE 2>> $MON_AGENT_UPGRADE_SCRIPT_LOG_FILE
	chown -vR $MON_AGENT_USER:$MON_AGENT_GROUP $MON_AGENT_WATCHDOG_BIN_BOOT_FILE 2>> $MON_AGENT_UPGRADE_SCRIPT_LOG_FILE
	chmod -vR 755 $MON_AGENT_WATCHDOG_BIN_BOOT_FILE 2>> $MON_AGENT_UPGRADE_SCRIPT_LOG_FILE
	chown -vR $MON_AGENT_USER:$MON_AGENT_GROUP $MON_AGENT_BIN_BOOT_FILE 2>> $MON_AGENT_UPGRADE_SCRIPT_LOG_FILE
	chmod -vR 755 $MON_AGENT_BIN_BOOT_FILE 2>> $MON_AGENT_UPGRADE_SCRIPT_LOG_FILE
}

checkNonRoot(){
	user_value="$(cat $MON_AGENT_TEMP_LOCKFILE)"
	if [ "$user_value" = "site24x7-agent" ]; then
		change_switch_value 1
	else
		change_switch_value 0
	fi
}

change_monagent_exec(){
	sed "s/MON_AGENT_PROG_NAME=.*/MON_AGENT_PROG_NAME=\"MonitoringAgent\.py\"/" $MON_AGENT_PROFILE > $NEW_MON_AGENT_PROFILE
	sed "s@MON_AGENT_EXEC_COMMAND=.*@MON_AGENT_EXEC_COMMAND=\"\$NOHUP_COMMAND $MON_AGENT_VENV_DIR_PYTHON \$MON_AGENT_LIB_DIR\/devops\/source\/python3.3\/src\/com\/manageengine\/monagent\/\$MON_AGENT_PROG_NAME >> \$MON_AGENT_ERR_FILE 2>\&1\"@" $MON_AGENT_BIN_BOOT_FILE > $NEW_MON_AGENT_BIN_BOOT_FILE
	mv $NEW_MON_AGENT_PROFILE $MON_AGENT_PROFILE 2>> $MON_AGENT_UPGRADE_SCRIPT_LOG_FILE
	mv $NEW_MON_AGENT_BIN_BOOT_FILE $MON_AGENT_BIN_BOOT_FILE 2>> $MON_AGENT_UPGRADE_SCRIPT_LOG_FILE
	chmod 755 $MON_AGENT_BIN_BOOT_FILE 2>> $MON_AGENT_UPGRADE_SCRIPT_LOG_FILE
	chmod 755 $MON_AGENT_PROFILE 2>> $MON_AGENT_UPGRADE_SCRIPT_LOG_FILE

}

copyVersionFiles(){
	cp -f $MON_AGENT_UPGRADE_HOME_DIR/bno.txt $MON_AGENT_HOME/bno.txt 2>> $MON_AGENT_UPGRADE_SCRIPT_LOG_FILE
	cp -f $MON_AGENT_UPGRADE_HOME_DIR/version.txt $MON_AGENT_HOME/version.txt 2>> $MON_AGENT_UPGRADE_SCRIPT_LOG_FILE
}

main() {
	createNecessaryDirs
	setPermissions
	checkNonRoot
	copyVersionFiles
	printf "\n [Before Upgrading Bin Executive files]\n------------------------------------------\n $(ls -lha $MON_AGENT_BIN_DIR) \n------------------------------------------\n" >> $MON_AGENT_UPGRADE_SCRIPT_LOG_FILE
	change_monagent_exec
	printf "\n [After Upgrading Bin Executive files]\n------------------------------------------\n $(ls -lha $MON_AGENT_BIN_DIR) \n------------------------------------------\n" >> $MON_AGENT_UPGRADE_SCRIPT_LOG_FILE
}

main
